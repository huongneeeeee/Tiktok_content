<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikVault Expert - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .chat-container {
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #475569 transparent;
        }

        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .message-bubble {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .bot-message {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }

        .source-card {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.2s;
        }

        .source-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .typing-indicator span {
            animation: blink 1.4s infinite both;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: 0.3;
            }

            40% {
                opacity: 1;
            }
        }

        .input-area {
            background: rgba(30, 41, 59, 0.95);
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .glow-border:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="bg-slate-800/80 backdrop-blur-md border-b border-slate-700 sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-8">
                <a href="/" class="flex items-center space-x-2">
                    <div class="bg-gradient-to-br from-blue-600 to-purple-600 p-2 rounded-lg">
                        <i class="fa-solid fa-brain text-white"></i>
                    </div>
                    <div>
                        <span class="text-xl font-bold text-white">TikVault</span>
                        <span class="text-purple-400 font-medium ml-1">Expert</span>
                    </div>
                </a>
            </div>
            <nav class="flex items-center space-x-6">
                <a href="/" class="text-slate-300 hover:text-white transition">Feed</a>
                <a href="/library" class="text-slate-300 hover:text-white transition">Library</a>
                <a href="/search" class="text-slate-300 hover:text-white transition">Search</a>
                <a href="/chat" class="text-white font-medium border-b-2 border-purple-500 pb-1">Chat</a>
                <button onclick="clearChat()" class="text-slate-400 hover:text-red-400 transition text-sm"
                    title="X√≥a l·ªãch s·ª≠ chat">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-4">
        <div class="chat-container max-w-4xl mx-auto">
            <!-- Messages Area -->
            <div class="messages-area px-4 py-6 space-y-4" id="messagesArea">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="message-bubble bot-message rounded-2xl rounded-tl-sm p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <div
                                class="bg-gradient-to-br from-blue-600 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-robot text-white text-sm"></i>
                            </div>
                            <span class="font-semibold text-white">TikVault Expert</span>
                        </div>
                        <p class="text-slate-300 leading-relaxed">
                            Xin ch√†o! T√¥i l√† <strong>TikVault Expert</strong> üß†<br><br>
                            T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m ki·∫øm v√† t·ªïng h·ª£p th√¥ng tin t·ª´ c√°c video TikTok b·∫°n ƒë√£ l∆∞u. H√£y th·ª≠
                            h·ªèi t√¥i:<br><br>
                            <span class="text-blue-400">‚Ä¢ "C√°ch l√†m ph·ªü b√≤ nh∆∞ th·∫ø n√†o?"</span><br>
                            <span class="text-blue-400">‚Ä¢ "Review qu√°n ƒÉn ngon ·ªü ƒê√† N·∫µng"</span><br>
                            <span class="text-blue-400">‚Ä¢ "Tips makeup t·ª± nhi√™n"</span><br>
                            <span class="text-blue-400">‚Ä¢ "ƒê·ªãa ƒëi·ªÉm du l·ªãch n√†o ƒë·∫πp?"</span>
                        </p>
                    </div>
                </div>

                <!-- Compare Mode Banner (hidden by default) -->
                <div id="compareBanner"
                    class="hidden bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-code-compare text-blue-400 text-xl"></i>
                            <div>
                                <div class="text-white font-medium">So s√°nh Videos</div>
                                <div id="compareVideoList" class="text-slate-400 text-sm"></div>
                            </div>
                        </div>
                        <a href="/chat" class="text-slate-400 hover:text-white transition">
                            <i class="fa-solid fa-times"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area p-4">
                <form id="chatForm" class="flex items-end space-x-3">
                    <div class="flex-1 relative">
                        <textarea id="messageInput" placeholder="H·ªèi v·ªÅ video ƒë√£ l∆∞u... (Ctrl+Enter ƒë·ªÉ g·ª≠i)" rows="1"
                            class="w-full bg-slate-800 text-white rounded-xl px-5 py-3.5 pr-14 outline-none border border-slate-700 glow-border transition resize-none overflow-y-auto"
                            style="min-height: 52px; max-height: 150px;" autocomplete="off"></textarea>
                        <button type="submit" id="sendBtn"
                            class="absolute right-2 bottom-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white w-10 h-10 rounded-lg flex items-center justify-center transition">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                <p class="text-center text-slate-500 text-xs mt-2">
                    TikVault Expert s·ª≠ d·ª•ng AI ƒë·ªÉ t√¨m ki·∫øm v√† t·ªïng h·ª£p th√¥ng tin t·ª´ video c·ªßa b·∫°n
                </p>
            </div>
        </div>
    </main>

    <script>
        const messagesArea = document.getElementById('messagesArea');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        // Storage key for localStorage
        const CHAT_STORAGE_KEY = 'tikvault_chat_history';

        // Conversation history for multi-turn context
        let conversationHistory = [];

        // UI message store (for restoring visual messages)
        let uiMessages = [];

        // Compare mode variables
        let compareVideoIds = [];
        let compareVideos = [];

        // Save chat to localStorage
        function saveChat() {
            const data = {
                history: conversationHistory,
                messages: uiMessages,
                timestamp: Date.now()
            };
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(data));
        }

        // Load chat from localStorage
        function loadChat() {
            try {
                const data = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY));
                if (data && data.messages && data.messages.length > 0) {
                    // Check if chat is not too old (24 hours)
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        conversationHistory = data.history || [];
                        uiMessages = data.messages || [];
                        restoreMessages();
                        return true;
                    }
                }
            } catch (e) {
                console.log('No saved chat or error loading:', e);
            }
            return false;
        }

        // Restore visual messages from uiMessages
        function restoreMessages() {
            for (const msg of uiMessages) {
                if (msg.type === 'user') {
                    addUserMessageNoSave(msg.content);
                } else if (msg.type === 'bot') {
                    addBotMessageNoSave(msg.content, msg.sources);
                }
            }
        }

        // Clear chat history
        function clearChat() {
            if (!confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) return;
            conversationHistory = [];
            uiMessages = [];
            localStorage.removeItem(CHAT_STORAGE_KEY);
            // Clear UI except welcome message
            const welcomeMsg = messagesArea.querySelector('.flex.justify-start');
            messagesArea.innerHTML = '';
            if (welcomeMsg) messagesArea.appendChild(welcomeMsg.cloneNode(true));
        }

        // Auto scroll to bottom
        function scrollToBottom() {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Add user message (with save)
        function addUserMessage(text) {
            addUserMessageNoSave(text);
            uiMessages.push({ type: 'user', content: text });
        }

        // Add user message (without save - for restore)
        function addUserMessageNoSave(text) {
            const html = `
                <div class="flex justify-end">
                    <div class="message-bubble user-message rounded-2xl rounded-tr-sm p-4">
                        <p class="text-white">${escapeHtml(text)}</p>
                    </div>
                </div>
            `;
            messagesArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // Add bot message (with save)
        function addBotMessage(answer, sources = []) {
            addBotMessageNoSave(answer, sources);
            uiMessages.push({ type: 'bot', content: answer, sources: sources });
            saveChat();
        }

        // Add bot message (without save - for restore)
        function addBotMessageNoSave(answer, sources = []) {
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="mt-4 pt-3 border-t border-slate-700">
                        <p class="text-xs text-slate-400 mb-2"><i class="fa-solid fa-video mr-1"></i> Video ngu·ªìn:</p>
                        <div class="flex flex-wrap gap-2">
                            ${sources.map(s => `
                                <a href="/video/${s.video_id}" target="_blank" 
                                   class="source-card px-3 py-1.5 rounded-lg text-xs text-slate-300 flex items-center space-x-2">
                                    <i class="fa-solid fa-play text-blue-400"></i>
                                    <span class="truncate max-w-[150px]">${escapeHtml(s.title || 'Video')}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="flex justify-start">
                    <div class="message-bubble bot-message rounded-2xl rounded-tl-sm p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="bg-gradient-to-br from-blue-600 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-robot text-white text-sm"></i>
                            </div>
                            <span class="font-semibold text-white">TikVault Expert</span>
                        </div>
                        <div class="text-slate-300 leading-relaxed prose prose-invert prose-sm max-w-none">
                            ${formatAnswer(answer)}
                        </div>
                        ${sourcesHtml}
                    </div>
                </div>
            `;
            messagesArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // Add typing indicator
        function addTypingIndicator() {
            const html = `
                <div class="flex justify-start" id="typingIndicator">
                    <div class="message-bubble bot-message rounded-2xl rounded-tl-sm p-4">
                        <div class="typing-indicator flex items-center space-x-1">
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            `;
            messagesArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        // Format answer with markdown-like styling
        function formatAnswer(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/- (.*?)(?=<br>|$)/g, '‚Ä¢ $1');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Submit handler with multi-turn history
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = messageInput.value.trim();
            if (!query) return;

            // Add user message to UI
            addUserMessage(query);
            messageInput.value = '';
            messageInput.disabled = true;

            // Show typing
            addTypingIndicator();

            try {
                // Send with conversation history
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        history: conversationHistory.slice(-6) // Send last 6 messages
                    })
                });
                const result = await response.json();

                removeTypingIndicator();

                if (result.success) {
                    addBotMessage(result.answer, result.sources);

                    // Store in history for multi-turn
                    conversationHistory.push({ role: 'user', content: query });
                    conversationHistory.push({ role: 'assistant', content: result.answer });

                    // Keep history manageable (max 20 messages)
                    if (conversationHistory.length > 20) {
                        conversationHistory.splice(0, 2);
                    }

                    saveChat();
                } else {
                    addBotMessage('Xin l·ªói, c√≥ l·ªói x·∫£y ra: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                removeTypingIndicator();
                addBotMessage('Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                messageInput.disabled = false;
                messageInput.focus();
            }
        });

        // Auto-resize textarea as user types
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Ctrl+Enter to submit, Enter for new line
        messageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Load saved chat on page load
        if (loadChat()) {
            console.log('‚úÖ Restored chat history from localStorage');
        }

        // Check for compare mode
        async function initCompareMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const compareParam = urlParams.get('compare');

            if (compareParam) {
                compareVideoIds = compareParam.split(',').map(id => id.trim()).filter(id => id);

                if (compareVideoIds.length >= 2) {
                    // 1. Show banner IMMEDIATELY
                    document.getElementById('compareBanner').classList.remove('hidden');
                    document.getElementById('compareVideoList').innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i th√¥ng tin ${compareVideoIds.length} video...`;

                    // Clear previous chat
                    clearChat(false);

                    // 2. Fetch video info (Parallel)
                    try {
                        const videoPromises = compareVideoIds.map(id =>
                            fetch(`/video/${id}`, { headers: { 'Accept': 'application/json' } })
                                .then(res => res.ok ? res.json() : null)
                                .catch(() => null)
                        );

                        const videos = (await Promise.all(videoPromises)).filter(v => v);
                        compareVideos = videos;

                        // Update Banner
                        document.getElementById('compareVideoList').textContent = `So s√°nh ${videos.length} videos: ${videos.map(v => v.title).join(', ').substring(0, 50)}...`;

                        // 3. Send comparison request
                        const comparePrompt = `H√£y so s√°nh v√† ph√¢n t√≠ch s·ª± kh√°c bi·ªát gi·ªØa ${videos.length} video n√†y. T√¨m ƒëi·ªÉm gi·ªëng v√† kh√°c nhau, ∆∞u ƒëi·ªÉm v√† nh∆∞·ª£c ƒëi·ªÉm c·ªßa m·ªói video.`;

                        addUserMessage(comparePrompt);
                        addTypingIndicator();

                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: comparePrompt,
                                compare_video_ids: compareVideoIds, // Send cleaned IDs
                                history: []
                            })
                        });
                        const result = await response.json();

                        removeTypingIndicator();

                        if (result.success) {
                            addBotMessage(result.answer, result.sources);
                            conversationHistory.push({ role: 'user', content: comparePrompt });
                            conversationHistory.push({ role: 'assistant', content: result.answer });
                            saveChat();
                        } else {
                            addBotMessage('‚ùå L·ªói: ' + (result.error || 'Server kh√¥ng ph·∫£n h·ªìi y√™u c·∫ßu so s√°nh.'));
                        }
                    } catch (err) {
                        console.error('Compare mode error:', err);
                        removeTypingIndicator();
                        addBotMessage('‚ùå C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi t·ªõi h·ªá th·ªëng so s√°nh.');
                    }
                }
            }
        }

        // Modified clearChat to optionally not confirm
        window.clearChat = function (confirm = true) {
            if (confirm && !window.confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) return;

            localStorage.removeItem(CHAT_STORAGE_KEY);
            conversationHistory = [];
            uiMessages = [];

            // Keep only welcome message
            const welcome = messagesArea.querySelector('.message-bubble.bot-message');
            messagesArea.innerHTML = '';
            if (welcome) {
                messagesArea.appendChild(welcome.parentElement);
            }
        };

        // Init compare mode if needed
        initCompareMode();

        // =============================================
        // Selected Videos Mode (from Library)
        // =============================================
        async function initSelectedMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedParam = urlParams.get('selected');

            if (!selectedParam) return;

            const videoIds = selectedParam.split(',').map(id => id.trim()).filter(id => id);
            if (videoIds.length === 0) return;

            // Show selected banner
            const compareBanner = document.getElementById('compareBanner');
            compareBanner.classList.remove('hidden');
            document.getElementById('compareVideoList').innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i ${videoIds.length} video ƒë√£ ch·ªçn...`;

            try {
                // Fetch all video content
                const videoPromises = videoIds.map(id =>
                    fetch(`/video/${id}`, { headers: { 'Accept': 'application/json' } })
                        .then(res => res.ok ? res.json() : null)
                        .catch(() => null)
                );

                const videos = (await Promise.all(videoPromises)).filter(v => v);

                // Update banner
                const titleList = videos.map(v => v.title || 'Video').join(', ');
                document.getElementById('compareVideoList').innerHTML = `
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-white">${videos.length} video ƒë√£ ch·ªçn:</span>
                        <span class="text-slate-400 text-xs truncate max-w-[300px]">${titleList}</span>
                    </div>
                `;

                // Format content for paste
                let clipboardContent = `# N·ªôi dung ${videos.length} videos ƒë√£ ch·ªçn\n\n`;

                for (const video of videos) {
                    const card = video.ai_analysis?.knowledge_card || {};
                    const classification = video.ai_analysis?.classification || {};

                    clipboardContent += `## ${video.title || 'Video'}\n`;
                    clipboardContent += `üìÇ Category: ${classification.category_path || 'N/A'}\n`;
                    clipboardContent += `üë§ Author: @${video.author?.nickname || 'unknown'}\n\n`;

                    if (card.summary) {
                        clipboardContent += `### T√≥m t·∫Øt\n${card.summary}\n\n`;
                    }

                    if (card.key_takeaways && card.key_takeaways.length > 0) {
                        clipboardContent += `### Key Takeaways\n`;
                        card.key_takeaways.forEach(t => clipboardContent += `- ${t}\n`);
                        clipboardContent += '\n';
                    }

                    if (card.action_items && card.action_items.length > 0) {
                        clipboardContent += `### C√°c b∆∞·ªõc\n`;
                        card.action_items.forEach((a, i) => clipboardContent += `${i + 1}. ${a}\n`);
                        clipboardContent += '\n';
                    }

                    clipboardContent += '---\n\n';
                }

                // Copy to clipboard automatically
                try {
                    await navigator.clipboard.writeText(clipboardContent);

                    // Show notification
                    addBotMessageNoSave(`‚úÖ **ƒê√£ copy n·ªôi dung ${videos.length} video v√†o clipboard!**\n\nB·∫°n c√≥ th·ªÉ:\n‚Ä¢ **Paste (Ctrl+V)** v√†o √¥ chat ƒë·ªÉ h·ªèi v·ªÅ c√°c video n√†y\n‚Ä¢ Ho·∫∑c g√µ c√¢u h·ªèi c·ªßa b·∫°n tr·ª±c ti·∫øp`, []);

                } catch (clipboardError) {
                    console.warn('Clipboard access denied:', clipboardError);
                    addBotMessageNoSave(`üìã **ƒê√£ t·∫£i ${videos.length} video**\n\nN·ªôi dung ƒë√£ s·∫µn s√†ng. H√£y h·ªèi t√¥i v·ªÅ c√°c video n√†y!`, []);
                }

                // Store video IDs for context
                window.selectedVideoIds = videoIds;

            } catch (error) {
                console.error('Error loading selected videos:', error);
                document.getElementById('compareVideoList').textContent = '‚ùå L·ªói khi t·∫£i video';
            }
        }

        // Init selected mode (only if not in compare mode)
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('compare')) {
            initSelectedMode();
        }

        // Focus input on load
        messageInput.focus();
    </script>
</body>

</html>