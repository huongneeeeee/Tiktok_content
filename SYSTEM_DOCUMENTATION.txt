================================================================================
                         TIKVAULT SYSTEM DOCUMENTATION
                              Version 2.2 (Public Edition)
                              Updated: January 9, 2026
================================================================================

1. TỔNG QUAN HỆ THỐNG
================================================================================

TikVault là hệ thống quản lý tri thức cá nhân (Personal Knowledge Management)
cho video TikTok. App dạng PUBLIC (không yêu cầu đăng nhập).

CHỨC NĂNG CHÍNH:
  ✓ Tải và phân tích video TikTok tự động
  ✓ Tạo Knowledge Cards với AI (OpenAI GPT-4o-mini)
  ✓ Phân loại theo 8 danh mục chính với subcategories
  ✓ Tìm kiếm ngữ nghĩa (Hybrid Search: Vector + Text)
  ✓ Chat RAG với knowledge base
  ✓ Collections để tổ chức video
  ✓ User notes, tags, favorites cho mỗi video
  ✓ Export Knowledge Card ra Markdown
  ✓ Backup video lên Google Drive (optional)

================================================================================

2. CẤU TRÚC THƯ MỤC
================================================================================

TikVault/
│
├── main.py                    # Entry point - chạy uvicorn server
├── config.py                  # Cấu hình (đọc từ .env)
├── requirements.txt           # Python dependencies
├── .env                       # Environment variables (API keys)
│
├── app/                       # ═══ APPLICATION PACKAGE ═══
│   ├── __init__.py           # App factory với lifespan management
│   ├── dependencies.py       # Shared: templates, helper functions
│   └── routers/              # API & Page routers
│       ├── __init__.py       # Router exports
│       ├── pages.py          # Frontend: /, /library, /search, /video, /chat
│       ├── videos.py         # Video APIs: process, search, delete, export
│       ├── chat.py           # Chat: /api/chat (RAG + Compare)
│       ├── collections.py    # Collections: CRUD + notes/tags/favorites
│       └── system.py         # System: /api/system/reset
│
├── services/                  # ═══ BUSINESS LOGIC LAYER ═══
│   ├── __init__.py           # Service exports
│   ├── database.py           # MongoDB + Qdrant integration (38KB)
│   ├── analyzer.py           # AI Knowledge Card generation (22KB)
│   ├── llm_chat.py           # RAG chat + Travel Planner + Compare (18KB)
│   ├── pipeline.py           # Video processing pipeline
│   ├── tiktok_tool.py        # TikTok scraper integration
│   ├── ai_processor.py       # FFmpeg audio + Whisper transcription
│   └── gdrive_sync.py        # Google Drive backup
│
├── templates/                 # ═══ JINJA2 HTML TEMPLATES ═══
│   ├── dashboard.html        # Home page với video grid (23KB)
│   ├── library.html          # Library với category/subcategory filters (28KB)
│   ├── search.html           # AI-powered search page (9KB)
│   ├── video_detail.html     # Video detail + Knowledge Card + Chat (46KB)
│   └── chat.html             # Full-page RAG chat assistant (27KB)
│
├── static/                    # ═══ STATIC FILES ═══
│   ├── css/                  # Stylesheets
│   └── js/                   # JavaScript files
│
├── TT_Content_Scraper/        # ═══ TIKTOK SCRAPER ENGINE ═══
│   └── [scraper modules]     # Custom TikTok video downloader
│
├── local_models/              # ═══ LOCAL AI MODELS ═══
│   └── bge-m3/               # Embedding model (BAAI/bge-m3, 1024 dims)
│
├── scraper_data/              # ═══ SCRAPER OUTPUT ═══
│   ├── content_files/        # Downloaded videos/images
│   └── progress.db           # SQLite tracking database
│
├── secrets/                   # ═══ CREDENTIALS ═══
│   └── gdrive_service.json   # Google Drive service account
│
└── temp/                      # ═══ TEMPORARY FILES ═══
    └── [processing files]    # Video/audio files during processing

================================================================================

3. TECH STACK CHI TIẾT
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                              BACKEND STACK                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Framework     │ FastAPI 0.100+        │ Async Python web framework          │
│ ASGI Server   │ Uvicorn               │ Lightning-fast ASGI server          │
│ Runtime       │ Python 3.10+          │ Required for type hints             │
│ Templates     │ Jinja2                │ Server-side HTML rendering          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              DATABASES                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ MongoDB       │ Document DB           │ Videos, collections, categories     │
│ Qdrant        │ Vector DB             │ Semantic search embeddings          │
│ SQLite        │ Scraper tracking      │ Download progress (built-in)        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              AI/ML STACK                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ LLM           │ OpenAI GPT-4o-mini    │ Knowledge Cards + Chat + Compare    │
│ Embeddings    │ BAAI/bge-m3 (local)   │ 1024-dim multilingual vectors       │
│ Reranker      │ ms-marco-TinyBERT     │ Cross-encoder for reranking         │
│ Transcription │ Whisper API (remote)  │ Via STT_API_URL endpoint            │
│ Audio         │ FFmpeg                │ Video → Audio conversion            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              EXTERNAL SERVICES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ TikTok        │ TT_Content_Scraper    │ Custom scraper (no official API)    │
│ Google Drive  │ Service Account       │ Video backup storage                │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================

4. API ENDPOINTS CHI TIẾT
================================================================================

╔═════════════════════════════════════════════════════════════════════════════╗
║                           FRONTEND PAGES                                     ║
║                         (app/routers/pages.py)                               ║
╠═════════════════════════════════════════════════════════════════════════════╣
║ GET  /                        │ Dashboard - video grid với sorting          ║
║                               │ Query: ?sort=newest|oldest|views|likes      ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ GET  /library                 │ Library - tất cả video với category filter  ║
║                               │ Query: ?category=X&sub=Y&sort=Z             ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ GET  /search                  │ AI Search page                              ║
║                               │ Query: ?q=search_query                      ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ GET  /video/{video_id}        │ Video detail page                           ║
║                               │ Accepts: text/html → HTML page              ║
║                               │ Accepts: application/json → JSON data       ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ GET  /chat                    │ Full-page RAG chat assistant                ║
╚═════════════════════════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════════════════════════╗
║                           VIDEO APIs                                         ║
║                         (app/routers/videos.py)                              ║
╠═════════════════════════════════════════════════════════════════════════════╣
║ POST /api/tiktok/process      │ Xử lý TikTok URL                            ║
║                               │ Body: {"url": "https://tiktok.com/..."}     ║
║                               │ Returns: {"success": true, "data": {...}}   ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ POST /api/text/upload         │ Upload text file để phân tích               ║
║                               │ Body: multipart/form-data (file)            ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ POST /api/search              │ Search videos (API endpoint)                ║
║                               │ Body: {"query": "tìm kiếm..."}              ║
║                               │ Returns: {"success": true, "results": [...]}║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ DELETE /api/video/{video_id}  │ Xóa video khỏi database                     ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ POST /api/video/{id}/reanalyze│ Re-analyze video với Knowledge Card mới    ║
╠───────────────────────────────┼─────────────────────────────────────────────╣
║ GET  /api/video/{id}/export   │ Export Knowledge Card ra Markdown           ║
║                               │ Query: ?format=markdown                     ║
╚═════════════════════════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════════════════════════╗
║                           CHAT API                                           ║
║                         (app/routers/chat.py)                                ║
╠═════════════════════════════════════════════════════════════════════════════╣
║ POST /api/chat                │ RAG Chat với knowledge base                 ║
║                               │                                             ║
║ Modes:                        │                                             ║
║ 1. General RAG:               │ {"query": "...", "history": [...]}          ║
║ 2. Single Video Context:      │ {"query": "...", "video_id": "xxx"}         ║
║ 3. Compare Mode:              │ {"query": "...",                            ║
║                               │  "compare_video_ids": ["id1", "id2"]}       ║
║                               │                                             ║
║ Returns: {"success": true,    │                                             ║
║           "answer": "...",    │                                             ║
║           "sources": [...]}   │                                             ║
╚═════════════════════════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════════════════════════╗
║                           COLLECTIONS & USER DATA                            ║
║                         (app/routers/collections.py)                         ║
╠═════════════════════════════════════════════════════════════════════════════╣
║ GET    /api/collections               │ List all collections                ║
║ POST   /api/collections               │ Create collection                   ║
║        Body: {"name": "...", "icon": "📁", "color": "#hex"}                 ║
║ PUT    /api/collections/{id}          │ Update collection                   ║
║ DELETE /api/collections/{id}          │ Delete collection                   ║
║ POST   /api/collections/{id}/videos   │ Add/remove video                    ║
║        Body: {"video_id": "...", "action": "add|remove"}                    ║
╠───────────────────────────────────────┼─────────────────────────────────────╣
║ PUT    /api/video/{id}/notes          │ Update user notes                   ║
║        Body: {"notes": "..."}         │                                     ║
║ PUT    /api/video/{id}/tags           │ Update user tags                    ║
║        Body: {"tags": ["tag1", ...]}  │                                     ║
║ PUT    /api/video/{id}/favorite       │ Toggle favorite                     ║
║        Body: {"is_favorite": true}    │                                     ║
╚═════════════════════════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════════════════════════╗
║                           SYSTEM                                             ║
║                         (app/routers/system.py)                              ║
╠═════════════════════════════════════════════════════════════════════════════╣
║ POST /api/system/reset        │ Reset entire database (DANGEROUS!)          ║
╚═════════════════════════════════════════════════════════════════════════════╝

================================================================================

5. DATABASE SCHEMA CHI TIẾT
================================================================================

═══════════════════════════════════════════════════════════════════════════════
                               MONGODB COLLECTIONS
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ COLLECTION: videos                                                          │
│ Purpose: Lưu trữ tất cả video đã import và phân tích                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ video_id          │ string    │ UNIQUE, PRIMARY │ TikTok video ID          │
│ type              │ string    │                 │ "video" | "text"         │
│ title             │ string    │                 │ Tiêu đề gốc              │
│ original_url      │ string    │                 │ URL TikTok gốc           │
│ filename          │ string    │                 │ Tên file đã tải          │
│ local_path        │ string    │                 │ Đường dẫn local          │
│ ─────────────────────────────────────────────────────────────────────────── │
│ author            │ object    │                 │                          │
│   ├── nickname    │ string    │                 │ Tên hiển thị             │
│   ├── id          │ string    │                 │ User ID                  │
│   └── avatar      │ string    │                 │ URL avatar               │
│ ─────────────────────────────────────────────────────────────────────────── │
│ stats             │ object    │                 │                          │
│   ├── views       │ number    │                 │ Số lượt xem              │
│   ├── likes       │ number    │                 │ Số likes                 │
│   ├── shares      │ number    │                 │ Số shares                │
│   └── comments    │ number    │                 │ Số comments              │
│ ─────────────────────────────────────────────────────────────────────────── │
│ transcript        │ string    │ TEXT INDEX      │ Nội dung transcript      │
│ hashtags          │ [string]  │                 │ Hashtags từ video        │
│ duration          │ number    │                 │ Thời lượng (giây)        │
│ thumbnail         │ string    │                 │ URL thumbnail            │
│ music_title       │ string    │                 │ Tên nhạc nền             │
│ create_time       │ datetime  │                 │ Thời gian đăng           │
│ ─────────────────────────────────────────────────────────────────────────── │
│ is_slideshow      │ boolean   │                 │ Có phải slideshow không  │
│ slideshow_images  │ [string]  │                 │ Danh sách ảnh slideshow  │
│ ─────────────────────────────────────────────────────────────────────────── │
│ ai_analysis       │ object    │                 │ KẾT QUẢ PHÂN TÍCH AI     │
│   ├── classification          │                 │                          │
│   │   ├── level_1 │ string    │ INDEX           │ Category chính           │
│   │   ├── level_2 │ string    │                 │ Subcategory              │
│   │   └── category_path       │                 │ "Level1 > Level2"        │
│   │                                                                         │
│   ├── knowledge_card          │                 │ KNOWLEDGE CARD           │
│   │   ├── title               │                 │ Tiêu đề refined          │
│   │   ├── summary             │                 │ Tóm tắt nội dung         │
│   │   ├── key_takeaways       │                 │ Điểm chính [array]       │
│   │   ├── action_items        │                 │ Các bước thực hiện       │
│   │   ├── entities            │                 │                          │
│   │   │   ├── ingredients     │                 │ Nguyên liệu (món ăn)     │
│   │   │   ├── products        │                 │ Sản phẩm được nhắc       │
│   │   │   └── locations       │                 │ Địa điểm                 │
│   │   ├── tags    │ [string]  │                 │ AI-generated tags        │
│   │   ├── knowledge_density   │                 │ Điểm 1-10                │
│   │   └── actionability       │                 │ Điểm 1-10                │
│   │                                                                         │
│   └── scores                  │                 │ (legacy field)           │
│ ─────────────────────────────────────────────────────────────────────────── │
│ drive_links       │ object    │                 │ Google Drive links       │
│   ├── video       │ string    │                 │ Link video               │
│   └── folder      │ string    │                 │ Link folder              │
│ ─────────────────────────────────────────────────────────────────────────── │
│ user_notes        │ string    │                 │ Ghi chú của user         │
│ user_tags         │ [string]  │                 │ Tags do user thêm        │
│ is_favorite       │ boolean   │                 │ Đánh dấu yêu thích       │
│ ─────────────────────────────────────────────────────────────────────────── │
│ processed_at      │ datetime  │ INDEX DESC      │ Thời gian import         │
│ updated_at        │ datetime  │                 │ Thời gian cập nhật       │
│ updated_by_user_at│ datetime  │                 │ User edit timestamp      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ COLLECTION: categories                                                      │
│ Purpose: Danh mục phân loại video (seeded tự động)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ key               │ string    │ UNIQUE          │ e.g., "ẨM_THỰC"          │
│ name              │ string    │                 │ Tên hiển thị             │
│ description       │ string    │                 │ Mô tả                    │
│ icon              │ string    │                 │ Font Awesome class       │
│ color             │ string    │                 │ Hex color code           │
│ order             │ number    │ INDEX ASC       │ Thứ tự sắp xếp           │
│ is_active         │ boolean   │                 │ Đang sử dụng             │
│ subcategories     │ [object]  │                 │                          │
│   ├── key         │ string    │                 │ Subcategory key          │
│   ├── name        │ string    │                 │ Tên hiển thị             │
│   └── tags        │ [string]  │                 │ Related tags             │
│ created_at        │ datetime  │                 │                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ COLLECTION: user_collections                                                │
│ Purpose: Collections do user tạo để tổ chức video                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ _id               │ ObjectId  │ PRIMARY         │ MongoDB auto-generated   │
│ name              │ string    │                 │ Tên collection           │
│ description       │ string    │                 │ Mô tả                    │
│ icon              │ string    │                 │ Emoji icon               │
│ color             │ string    │                 │ Hex color                │
│ video_ids         │ [string]  │                 │ Danh sách video_id       │
│ created_at        │ datetime  │                 │                          │
│ updated_at        │ datetime  │ INDEX DESC      │                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ COLLECTION: search_logs                                                     │
│ Purpose: Log search queries cho analytics                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ query             │ string    │ TEXT INDEX      │ Search query             │
│ results_count     │ number    │                 │ Số kết quả               │
│ result_ids        │ [string]  │                 │ Video IDs returned       │
│ created_at        │ datetime  │ INDEX DESC      │                          │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
                              QDRANT VECTOR DATABASE
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ COLLECTION: video_chunks_bge_m3                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Vector Config:                                                              │
│   ├── Dimensions: 1024                                                      │
│   ├── Distance: Cosine                                                      │
│   └── Model: BAAI/bge-m3 (multilingual)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Payload Fields:                                                             │
│   ├── video_id            │ string    │ Reference to MongoDB               │
│   ├── title               │ string    │ Original title                     │
│   ├── refined_title       │ string    │ AI-refined title                   │
│   ├── chunk_text          │ string    │ Embedded text content              │
│   ├── summary             │ string    │ Knowledge Card summary             │
│   ├── key_takeaways       │ [string]  │ Main points                        │
│   ├── category_path       │ string    │ "Level1 > Level2"                  │
│   ├── category_l1         │ string    │ Level 1 category                   │
│   ├── knowledge_density   │ number    │ Score 1-10                         │
│   ├── actionability       │ number    │ Score 1-10                         │
│   ├── tags                │ [string]  │ AI tags                            │
│   ├── author              │ object    │ Author info                        │
│   ├── stats               │ object    │ View/like stats                    │
│   ├── filename            │ string    │ Local filename                     │
│   └── drive_links         │ object    │ GDrive links                       │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================

6. CATEGORY TREE (8 DANH MỤC CHÍNH)
================================================================================

┌───────────────────────────────────────────────────────────────────────────┐
│ 📚 HỌC_HỎI - Videos dạy kỹ năng, kiến thức có thể áp dụng                │
│    ├── Tutorial       │ Hướng dẫn, How-to, DIY                            │
│    ├── Ngôn_Ngữ       │ Tiếng Anh, Hàn, Nhật, Từ vựng                     │
│    ├── Tech_Review    │ Công nghệ, App review, Unboxing                   │
│    ├── Mẹo_Hay        │ Life hacks, Tips tiết kiệm                        │
│    └── Kiến_Thức      │ Khoa học, Lịch sử, Facts                          │
├───────────────────────────────────────────────────────────────────────────┤
│ 🍳 ẨM_THỰC - Mọi thứ liên quan đến ăn uống, nấu nướng                     │
│    ├── Công_Thức      │ Recipe, Món ăn, Làm bánh                          │
│    ├── Review_Quán    │ Địa điểm ăn, Street food, Quán mới                │
│    ├── Mẹo_Bếp        │ Tips nấu ăn, Bảo quản, Dinh dưỡng                 │
│    ├── Đồ_Uống        │ Cà phê, Trà sữa, Cocktail, Smoothie               │
│    └── Mukbang        │ ASMR ăn, Thử thách ăn, Food challenge             │
├───────────────────────────────────────────────────────────────────────────┤
│ 💄 PHONG_CÁCH - Thời trang, làm đẹp, chăm sóc bản thân                    │
│    ├── Outfit         │ OOTD, Phối đồ, GRWM                               │
│    ├── Makeup         │ Trang điểm, Tutorial, Biến hình                   │
│    ├── Skincare       │ Chăm da, Review mỹ phẩm, Routine                  │
│    ├── Tóc_Nail       │ Kiểu tóc, Nail art, Nhuộm tóc                     │
│    └── Review_SP      │ Review sản phẩm thời trang/mỹ phẩm, Haul          │
├───────────────────────────────────────────────────────────────────────────┤
│ 🌏 KHÁM_PHÁ - Du lịch, địa điểm, trải nghiệm mới lạ                       │
│    ├── Điểm_Đến       │ Check-in, Hidden gems, Cảnh đẹp                   │
│    ├── Lưu_Trú        │ Khách sạn, Resort, Homestay                       │
│    ├── Trải_Nghiệm    │ Tour, Camping, Phượt                              │
│    ├── Ẩm_Thực_Local  │ Đặc sản vùng miền, Food tour                      │
│    └── Tips_Du_Lịch   │ Kinh nghiệm, Packing, Budget                      │
├───────────────────────────────────────────────────────────────────────────┤
│ 📱 ĐỜI_THƯỜNG - Chia sẻ cuộc sống, vlog, câu chuyện hàng ngày            │
│    ├── Vlog           │ Daily life, Behind the scenes, Một ngày          │
│    ├── Gia_Đình       │ Parenting, Baby, Thú cưng                         │
│    ├── Tâm_Sự         │ Chia sẻ, Advice, Confession                       │
│    ├── Công_Sở        │ Career, WFH, Phỏng vấn                            │
│    └── Tin_Tức        │ Thời sự, Xu hướng, Cập nhật                       │
├───────────────────────────────────────────────────────────────────────────┤
│ 😂 GIẢI_TRÍ - Xem cho vui, thư giãn, nội dung giải trí                    │
│    ├── Hài            │ Comedy, Prank, POV hài                            │
│    ├── Nhạc_Dance     │ Cover, Vũ đạo, Challenge                          │
│    ├── Phim_Game      │ Review phim, Gaming, Esports                      │
│    ├── Trend          │ Meme, Viral, CapCut edit                          │
│    └── Pets           │ Động vật cute, Funny, Chó mèo hài hước            │
├───────────────────────────────────────────────────────────────────────────┤
│ ❤️ CẢM_XÚC - Nội dung thiên về cảm xúc, tâm trạng, mood                   │
│    ├── Chill          │ Aesthetic, Lofi, Thư giãn, Vibes                  │
│    ├── Motivation     │ Động lực, Quotes, Năng lượng                      │
│    ├── Tình_Yêu       │ Couple, Chia tay, Crush                           │
│    ├── Healing        │ Chữa lành, Self-care, An ủi                       │
│    └── Throwback      │ Hoài niệm, Kỷ niệm, Nostalgia                     │
├───────────────────────────────────────────────────────────────────────────┤
│ 📦 KHÁC - Video không thuộc danh mục nào hoặc không có giá trị            │
│    ├── Quảng_Cáo      │ Sponsored, Ads, Promote                           │
│    ├── Không_Rõ       │ Chưa phân loại, Mơ hồ                             │
│    └── Rác            │ Spam, Lỗi, Test                                   │
└───────────────────────────────────────────────────────────────────────────┘

AI CLASSIFICATION STRATEGY:
  ┌────────────────────────────────────────────────────────────────────────┐
  │ NHÓM KIẾN THỨC (Chi tiết extraction):                                 │
  │   HỌC_HỎI, ẨM_THỰC, PHONG_CÁCH, KHÁM_PHÁ, ĐỜI_THƯỜNG                   │
  │   → Output: summary, key_takeaways, action_items, entities, tags      │
  ├────────────────────────────────────────────────────────────────────────┤
  │ NHÓM GIẢI TRÍ (Light extraction):                                     │
  │   GIẢI_TRÍ, CẢM_XÚC, KHÁC                                              │
  │   → Output: summary, tags (only)                                       │
  └────────────────────────────────────────────────────────────────────────┘

================================================================================

7. SEARCH FLOW (HYBRID SEARCH)
================================================================================

                    ┌─────────────────────────────────────┐
                    │         USER QUERY                  │
                    │    "cách làm bánh mì"               │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: EMBEDDING                                                           │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Encode query với bge-m3 model (local)                                    │
│ • Output: 1024-dimensional vector                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: VECTOR SEARCH (Qdrant)                                             │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Cosine similarity search trong video_chunks_bge_m3                       │
│ • Lấy top N*3 candidates (để có đủ sau dedup)                              │
│ • Filter: score >= 0.45 threshold                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: CATEGORY DETECTION & BOOST                                         │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Detect category intent từ keywords trong query                           │
│ • Boost 1.3x cho matching category, 1.5x cho exact subcategory             │
│ • Penalize 0.5x cho non-matching categories                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: MONGODB LOOKUP                                                      │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Fetch full metadata cho unique video_ids                                 │
│ • Include: transcript, ai_analysis, author, stats, etc.                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: RAG ANSWER GENERATION (OpenAI)                                     │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Build context từ top 3-5 results                                         │
│ • Generate answer với GPT-4o-mini                                          │
│ • Support multi-turn conversation với history                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │         RESPONSE                    │
                    │  {answer, sources: [...videos]}     │
                    └─────────────────────────────────────┘

FALLBACK MODES:
  • Nếu Qdrant không có kết quả → MongoDB text search
  • Nếu text search cũng không → MongoDB regex search

================================================================================

8. VIDEO PROCESSING PIPELINE
================================================================================

                    ┌─────────────────────────────────────┐
                    │      TikTok URL Input               │
                    │  https://tiktok.com/@user/video/xxx │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: DOWNLOAD (tiktok_tool.py)                                          │
│ ────────────────────────────────────────────────────────────────────────── │
│ • TT_Content_Scraper tải video/slideshow                                   │
│ • Extract metadata: title, author, stats, hashtags                         │
│ • Detect slideshow → tải images                                            │
│ • Save to scraper_data/content_files/                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: TRANSCRIPTION (ai_processor.py)                                    │
│ ────────────────────────────────────────────────────────────────────────── │
│ • FFmpeg: Video → Audio (WAV 16kHz mono)                                   │
│ • Split thành chunks 2 phút (cho video dài)                                │
│ • Send to Whisper API (STT_API_URL)                                        │
│ • Merge transcripts                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: AI ANALYSIS (analyzer.py)                                          │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Send transcript + metadata to GPT-4o-mini                                │
│ • Generate Knowledge Card với adaptive extraction:                         │
│   - Nhóm Kiến Thức: Full extraction                                        │
│   - Nhóm Giải Trí: Summary only                                            │
│ • Output: classification + knowledge_card                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: GOOGLE DRIVE BACKUP (gdrive_sync.py) [OPTIONAL]                    │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Upload video to GDrive (if GDRIVE_FOLDER_ID set)                         │
│ • Store drive_links in document                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: DATABASE STORAGE (database.py)                                     │
│ ────────────────────────────────────────────────────────────────────────── │
│ • Upsert document to MongoDB (videos collection)                           │
│ • Generate embeddings từ Knowledge Card content                            │
│ • Store vectors in Qdrant (video_chunks_bge_m3)                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │       Video Ready in Library        │
                    │   Searchable + Browsable + RAG      │
                    └─────────────────────────────────────┘

================================================================================

9. CHAT MODES (llm_chat.py)
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODE 1: GENERAL RAG SEARCH                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Trigger: Normal query without video context                                │
│ Flow:                                                                       │
│   1. Search videos matching query                                          │
│   2. Build context from top results                                        │
│   3. Generate answer with citations                                        │
│ Request: {"query": "cách làm bánh", "history": [...]}                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODE 2: SINGLE VIDEO CONTEXT                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Trigger: Query với video_id (từ video detail page)                         │
│ Flow:                                                                       │
│   1. Fetch specific video                                                  │
│   2. Use full transcript as context                                        │
│   3. Answer questions about that video                                     │
│ Request: {"query": "video này nói về gì?", "video_id": "xxx"}               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODE 3: COMPARE MODE                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Trigger: Query với compare_video_ids (từ Library multi-select)             │
│ Flow:                                                                       │
│   1. Fetch all selected videos (2-5)                                       │
│   2. Build comparison context                                              │
│   3. Generate structured comparison analysis                               │
│ Request: {"query": "so sánh", "compare_video_ids": ["id1", "id2"]}          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODE 4: TRAVEL PLANNER                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ Trigger: Keywords like "lên kế hoạch", "lịch trình", "itinerary"           │
│ Flow:                                                                       │
│   1. Search relevant travel videos                                         │
│   2. Synthesize into structured travel plan                                │
│   3. Output: day-by-day itinerary with sources                             │
│ Request: {"query": "lên lịch trình đi Đà Lạt 3 ngày"}                       │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================

10. ENVIRONMENT VARIABLES (.env)
================================================================================

# ═══ REQUIRED ═══
OPENAI_API_KEY=sk-...                    # OpenAI API key (GPT-4o-mini)

# ═══ DATABASE ═══
MONGO_URI=mongodb://localhost:27017      # MongoDB connection string
QDRANT_HOST=localhost                    # Qdrant server host
QDRANT_PORT=6333                         # Qdrant server port

# ═══ OPTIONAL SERVICES ═══
GDRIVE_FOLDER_ID=                        # Google Drive folder ID for backup
STT_API_URL=http://localhost:8019/stt/simple  # Whisper STT endpoint

# ═══ DEPRECATED (không còn dùng) ═══
# GEMINI_API_KEY=                        # Đã chuyển sang OpenAI

================================================================================

11. CHẠY ỨNG DỤNG
================================================================================

PREREQUISITES:
  ✓ Python 3.10+
  ✓ MongoDB running (localhost:27017)
  ✓ Qdrant running (localhost:6333)
  ✓ FFmpeg installed and in PATH
  ✓ Whisper STT API running (optional, for transcription)

INSTALLATION:

  # Clone/download project
  cd TikVault

  # Create virtual environment
  python -m venv venv
  
  # Activate (Windows)
  .\venv\Scripts\activate
  
  # Install dependencies
  pip install -r requirements.txt
  
  # Copy environment template
  copy .env.example .env
  # Edit .env với API keys của bạn

RUN SERVER:

  # Development mode (auto-reload)
  python main.py
  
  # → Server running at: http://127.0.0.1:8000

FIRST USE:
  1. Mở browser: http://127.0.0.1:8000
  2. Click "Import Video" button
  3. Paste TikTok URL
  4. Wait for processing (30s - 2min depending on video length)
  5. Video appears in Dashboard & Library

================================================================================

12. TROUBLESHOOTING
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM: ModuleNotFoundError: No module named 'openai'                     │
│ SOLUTION: pip install openai                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM: MongoDB connection failed                                          │
│ SOLUTION:                                                                   │
│   1. Check MongoDB service is running                                      │
│   2. Verify MONGO_URI in .env                                              │
│   3. Default: mongodb://localhost:27017                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM: Qdrant connection failed                                           │
│ SOLUTION:                                                                   │
│   1. Start Qdrant: docker run -p 6333:6333 qdrant/qdrant                   │
│   2. Or download Qdrant binary and run                                     │
│   3. Check QDRANT_HOST and QDRANT_PORT in .env                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM: Transcription returns empty                                        │
│ SOLUTION:                                                                   │
│   1. Check STT_API_URL is accessible                                       │
│   2. Video may have no speech (music only)                                 │
│   3. Check FFmpeg is installed: ffmpeg -version                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM: TikTok download fails                                              │
│ SOLUTION:                                                                   │
│   1. URL may be private or deleted                                         │
│   2. TikTok may have changed their API                                     │
│   3. Check scraper_data/progress.db for error logs                         │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================

13. MAINTENANCE
================================================================================

BACKUP DATA:
  • MongoDB: mongodump --db tikvault_db --out backup/
  • Qdrant: Copy qdrant_storage/ folder
  • Videos: Sync scraper_data/content_files/ to cloud

CLEAN TEMP FILES:
  • Delete temp/*.mp4, temp/*.wav, temp/*.txt
  • These are created during processing

RESET DATABASE:
  • POST /api/system/reset (WARNING: Xóa tất cả data!)
  • Or manually: drop tikvault_db in MongoDB

UPDATE CATEGORIES:
  • Edit services/analyzer.py → CATEGORY_TREE
  • Delete categories collection in MongoDB
  • Restart server → auto-seed new categories

================================================================================
                              END OF DOCUMENTATION
                              TikVault v2.2 - January 2026
================================================================================